name: Deploy Demo

on:
  workflow_run:
    workflows: ["Docker"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
    environment:
      name: staging
      url: "${{ env.SERVER_URL }}"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Copy docker-compose file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "deployments/demo/docker-compose.staging.yml"
          target: "~/topbanana-staging"
          strip_components: 2

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          IMAGE_TAG: edge
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: IMAGE_NAME,IMAGE_TAG,GITHUB_TOKEN,GITHUB_ACTOR
          script: |
            set -e
            mkdir -p ~/topbanana-staging
            cd ~/topbanana-staging
            mv -f docker-compose.staging.yml docker-compose.yml
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            docker compose pull
            docker compose up -d
            docker image prune -af
            docker logout ghcr.io

      - name: Verify staging deployment
        run: |
          sleep 10
          curl -f "${{ secrets.HEALTH_URL }}" || echo "Health check failed, but deployment may still be starting up"

  deploy-production:
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v')) || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    environment:
      name: production
      url: "${{ env.SERVER_URL }}"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Determine image tag
        id: tag
        run: |
          IMAGE_TAG="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          IMAGE_TAG="${IMAGE_TAG#v}"
          if [[ ! "$IMAGE_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            IMAGE_TAG="latest"
          fi
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Copy docker-compose file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "deployments/demo/docker-compose.production.yml"
          target: "~/topbanana-production"
          strip_components: 2

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: IMAGE_NAME,IMAGE_TAG,GITHUB_TOKEN,GITHUB_ACTOR
          script: |
            set -e
            mkdir -p ~/topbanana-production
            cd ~/topbanana-production
            mv -f docker-compose.production.yml docker-compose.yml
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            docker compose pull
            docker compose up -d
            docker image prune -af
            docker logout ghcr.io

      - name: Verify production deployment
        run: |
          sleep 10
          curl -f "${{ secrets.HEALTH_URL }}" || echo "Health check failed, but deployment may still be starting up"
